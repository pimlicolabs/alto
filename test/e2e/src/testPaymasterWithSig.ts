// Utils for deploying TestPaymasterWithSig contract (EntryPoint 0.9 only)
// This paymaster validates paymasterSignature field where two uint256 values must add up to 100

import {
    http,
    type Address,
    type Hex,
    concat,
    createPublicClient,
    getCreate2Address,
    pad,
    parseEther
} from "viem"
import { entryPoint09Address } from "viem/account-abstraction"
import { foundry } from "viem/chains"
import { getAnvilWalletClient } from "./utils/index.js"

// TestPaymasterWithSig bytecode
// Expects signedPaymasterData to decode to 0x11
// Expects paymasterSignature to decode to (uint256 a, uint256 b) where a + b == 100
// Get bytecode from: cat contracts/out/TestPaymasterWithSig.sol/TestPaymasterWithSig.json | jq -r '.bytecode.object'
const PAYMASTER_WITH_SIG_BYTECODE: Hex =
    "0x60a0806040523461016557602081610e23803803809161001f828561018f565b83398101031261016557516001600160a01b03811680820361016557331561017c57600180546001600160a01b03199081169091555f8054339281168317825560405192916001600160a01b03909116907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09080a36301ffc9a760e01b815263283f548960e01b6004820152602081602481855afa908115610171575f91610132575b50156101155750608052604051610c5c90816101c7823960805181818161016801528181610241015281816102eb015281816103880152818161040d015281816106840152818161073101526108330152f35b6365d25c7160e01b5f5260045263283f548960e01b60245260445ffd5b90506020813d602011610169575b8161014d6020938361018f565b8101031261016557518015158103610165575f6100c2565b5f80fd5b3d9150610140565b6040513d5f823e3d90fd5b631e4fbdf760e01b5f525f60045260245ffd5b601f909101601f19168101906001600160401b038211908210176101b257604052565b634e487b7160e01b5f52604160045260245ffdfe60806040526004361015610011575f80fd5b5f5f3560e01c80630396cb6014610701578063205c28781461065757806352b7512c146105d6578063715018a61461056d57806379ba5097146104e45780637c627b21146104575780638da5cb5b14610431578063b0d691fe146103ed578063bb9fe6bf14610364578063c23a5cea146102be578063c399ec88146101f3578063d0e30db014610151578063e30c39781461012a5763f2fde38b146100b4575f80fd5b34610127576020366003190112610127576004356001600160a01b038116809103610125576100e1610803565b806001600160a01b031960015416176001556001600160a01b038254167f38d16b8cac22d99fc7c124b9cd0de2d3fa1faef420bfe791d8c362d765e227008380a380f35b505b80fd5b503461012757806003193601126101275760206001600160a01b0360015416604051908152f35b508060031936011261012757806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b156101f05781602491604051928380927fb760faf900000000000000000000000000000000000000000000000000000000825230600483015234905af180156101e5576101d45750f35b816101de916107cd565b6101275780f35b6040513d84823e3d90fd5b50fd5b5034610127578060031936011261012757604051907f70a082310000000000000000000000000000000000000000000000000000000082523060048301526020826024816001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000165afa9081156102b2579061027b575b602090604051908152f35b506020813d6020116102aa575b81610295602093836107cd565b810103126102a65760209051610270565b5f80fd5b3d9150610288565b604051903d90823e3d90fd5b503461012757602036600319011261012757806102d96107b7565b6102e1610803565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610360576001600160a01b03602484928360405195869485937fc23a5cea0000000000000000000000000000000000000000000000000000000085521660048401525af180156101e5576101d45750f35b5050fd5b503461012757806003193601126101275761037d610803565b806001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016803b156101f0578180916004604051809481937fbb9fe6bf0000000000000000000000000000000000000000000000000000000083525af180156101e5576101d45750f35b503461012757806003193601126101275760206040516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000168152f35b50346101275780600319360112610127576001600160a01b036020915416604051908152f35b503461012757608036600319011261012757600360043510156101275760243567ffffffffffffffff8111610125573660238201121561012557806004013567ffffffffffffffff81116104e05736910160240111610127576004906104bb610829565b7f25ad501f000000000000000000000000000000000000000000000000000000008152fd5b8280fd5b5034610127578060031936011261012757336001600160a01b03600154160361055a576001600160a01b0319600154166001558054336001600160a01b031982161782556001600160a01b033391167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08380a380f35b8063118cdaa760e01b6024925233600452fd5b5034610127578060031936011261012757610586610803565b6001600160a01b031960015416600155806001600160a01b0381546001600160a01b031981168355167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a380f35b50346101275760603660031901126101275760043567ffffffffffffffff8111610125576101206003198236030112610125576020610621606092610619610829565b6004016108e4565b604092919251948593604085528051938491826040880152018686015e8383018501526020830152601f01601f19168101030190f35b503461012757604036600319011261012757806106726107b7565b61067a610803565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b15610360576001600160a01b03604484928360405195869485937f205c287800000000000000000000000000000000000000000000000000000000855216600484015260243560248401525af180156101e5576101d45750f35b5060203660031901126102a65760043563ffffffff81168091036102a657610727610803565b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690813b156102a6575f906024604051809481937f0396cb60000000000000000000000000000000000000000000000000000000008352600483015234905af180156107ac5761079e575080f35b6107aa91505f906107cd565b005b6040513d5f823e3d90fd5b600435906001600160a01b03821682036102a657565b90601f8019910116810190811067ffffffffffffffff8211176107ef57604052565b634e487b7160e01b5f52604160045260245ffd5b6001600160a01b035f5416330361081657565b63118cdaa760e01b5f523360045260245ffd5b6001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001680330361085d5750565b7ffe34a6d3000000000000000000000000000000000000000000000000000000005f52336004523060245260445260645ffd5b903590601e19813603018212156102a6570180359067ffffffffffffffff82116102a6576020019181360383136102a657565b919082018092116108d057565b634e487b7160e01b5f52601160045260245ffd5b60e081016108f28183610890565b906108fd8282610aba565b829080610a84575b50826034116102a65782116102a65760331982019167ffffffffffffffff83116107ef57604051926109426014198301601f1916602001856107cd565b808452602084019336838501116102a6575f85936020959360348795018637820160131901528051010103126102a65760ff601191511603610a405761099161098b8284610890565b90610aba565b80156109fc576109a66109ac92604094610890565b90610bfe565b90809291810103126102a6576109ca816020606493013590356108c3565b036109e5576040516109dd6020826107cd565b5f8152905f90565b6040516109f36020826107cd565b5f815290600190565b606460405162461bcd60e51b815260206004820152601460248201527f6d697373696e67207061796d61737465725369670000000000000000000000006044820152fd5b606460405162461bcd60e51b815260206004820152601660248201527f65787065637465642074657374446174613d30783131000000000000000000006044820152fd5b909250600a81018091116108d05782038281116108d057915f610905565b909392938483116102a65784116102a6578101920390565b603e8210610be3577f22e325a2974396560000000000000000000000000000000000000000000000007fffffffffffffffff000000000000000000000000000000000000000000000000610b148460071981018186610aa2565b90358281169160088110610be9575b50501603610be35781610b3c9181600919810191610aa2565b90357fffff00000000000000000000000000000000000000000000000000000000000081169160028110610bae575b505060f01c90603d1981018211610b80575090565b7f07b9a191000000000000000000000000000000000000000000000000000000005f5260045260245260445ffd5b7fffff0000000000000000000000000000000000000000000000000000000000009250829060020360031b1b16165f80610b6b565b50505f90565b839250829060080360031b1b16165f80610b23565b91908115610c1f57610c1b92600919808301938303019190610aa2565b9091565b5050905f9056fea264697066735822122022b523e6aef21a0306cdd687b8363dca6222369ce3c3ef28d9903053c7af726264736f6c634300081c0033"

export const deployTestPaymasterWithSig = async ({
    anvilRpc,
    salt = "0x0000000000000000000000000000000000000000000000000000000000000001",
    funded = true
}: {
    anvilRpc: string
    salt?: Hex
    funded?: boolean
}): Promise<Address> => {
    const publicClient = createPublicClient({
        transport: http(anvilRpc),
        chain: foundry
    })

    const counterFactual = getCreate2Address({
        from: "0x4e59b44847b379578588920ca78fbf26c0b4956c",
        salt,
        bytecode: concat([
            PAYMASTER_WITH_SIG_BYTECODE,
            pad(entryPoint09Address)
        ])
    })

    const bytecode = await publicClient.getCode({
        address: counterFactual
    })

    if (!bytecode) {
        const walletClient = getAnvilWalletClient({
            addressIndex: 0,
            anvilRpc
        })

        await walletClient.sendTransaction({
            data: concat([
                salt,
                PAYMASTER_WITH_SIG_BYTECODE,
                pad(entryPoint09Address)
            ]),
            to: "0x4e59b44847b379578588920ca78fbf26c0b4956c"
        })

        if (funded) {
            await walletClient.sendTransaction({
                to: counterFactual,
                value: parseEther("100"),
                data: "0xd0e30db0" /* sig for deposit() */
            })
        }
    }

    return counterFactual
}
