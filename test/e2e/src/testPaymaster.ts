// Utils for interacting with the contract located in alto/contracts/TestUtils/Paymaster.sol
// This paymaster will sponsor all UserOperations

import {
    http,
    type Address,
    type Hex,
    concat,
    createPublicClient,
    getCreate2Address,
    pad,
    parseEther
} from "viem"
import { entryPoint06Address } from "viem/account-abstraction"
import { foundry } from "viem/chains"
import { ANVIL_RPC } from "./constants"
import { getAnvilWalletClient } from "./utils"

const PAYMASTER_V06_BYTECODE: Hex =
    "0x60a060405234801561001057600080fd5b50604051610b57380380610b5783398101604081905261002f9161009b565b806100393361004b565b6001600160a01b0316608052506100cb565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6000602082840312156100ad57600080fd5b81516001600160a01b03811681146100c457600080fd5b9392505050565b608051610a406101176000396000818161015f01528181610251015281816102e801528181610364015281816103f80152818161046f015281816104fc01526106a00152610a406000f3fe6080604052600436106100a75760003560e01c8063bb9fe6bf11610064578063bb9fe6bf14610181578063c23a5cea14610196578063c399ec88146101b6578063d0e30db0146101d9578063f2fde38b146101e1578063f465c77e1461020157600080fd5b80630396cb60146100ac578063205c2878146100c1578063715018a6146100e15780638da5cb5b146100f6578063a9a234091461012d578063b0d691fe1461014d575b600080fd5b6100bf6100ba3660046107dd565b61022f565b005b3480156100cd57600080fd5b506100bf6100dc36600461081f565b6102ba565b3480156100ed57600080fd5b506100bf61032c565b34801561010257600080fd5b506000546001600160a01b03165b6040516001600160a01b0390911681526020015b60405180910390f35b34801561013957600080fd5b506100bf61014836600461084b565b610340565b34801561015957600080fd5b506101107f000000000000000000000000000000000000000000000000000000000000000081565b34801561018d57600080fd5b506100bf61035a565b3480156101a257600080fd5b506100bf6101b13660046108dd565b6103d1565b3480156101c257600080fd5b506101cb610457565b604051908152602001610124565b6100bf6104e7565b3480156101ed57600080fd5b506100bf6101fc3660046108dd565b610549565b34801561020d57600080fd5b5061022161021c3660046108fa565b6105c7565b60405161012492919061094e565b6102376105eb565b604051621cb65b60e51b815263ffffffff821660048201527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031690630396cb609034906024016000604051808303818588803b15801561029e57600080fd5b505af11580156102b2573d6000803e3d6000fd5b505050505050565b6102c26105eb565b60405163040b850f60e31b81526001600160a01b038381166004830152602482018390527f0000000000000000000000000000000000000000000000000000000000000000169063205c287890604401600060405180830381600087803b15801561029e57600080fd5b6103346105eb565b61033e6000610645565b565b610348610695565b61035484848484610705565b50505050565b6103626105eb565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031663bb9fe6bf6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156103bd57600080fd5b505af1158015610354573d6000803e3d6000fd5b6103d96105eb565b60405163611d2e7560e11b81526001600160a01b0382811660048301527f0000000000000000000000000000000000000000000000000000000000000000169063c23a5cea90602401600060405180830381600087803b15801561043c57600080fd5b505af1158015610450573d6000803e3d6000fd5b5050505050565b6040516370a0823160e01b81523060048201526000907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156104be573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104e291906109a3565b905090565b60405163b760faf960e01b81523060048201527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169063b760faf99034906024016000604051808303818588803b15801561043c57600080fd5b6105516105eb565b6001600160a01b0381166105bb5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084015b60405180910390fd5b6105c481610645565b50565b606060006105d3610695565b6105de85858561073d565b915091505b935093915050565b6000546001600160a01b0316331461033e5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016105b2565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161461033e5760405162461bcd60e51b815260206004820152601560248201527414d95b99195c881b9bdd08115b9d1c9e541bda5b9d605a1b60448201526064016105b2565b60405162461bcd60e51b815260206004820152600d60248201526c6d757374206f7665727269646560981b60448201526064016105b2565b6060600060146107516101208701876109bc565b9050111561077e5761076660016000806107a5565b604080516020810190915260008152925090506105e3565b61078b60008060006107a5565b604080516020810190915260008152969095509350505050565b600060d08265ffffffffffff16901b60a08465ffffffffffff16901b856107cd5760006107d0565b60015b60ff161717949350505050565b6000602082840312156107ef57600080fd5b813563ffffffff8116811461080357600080fd5b9392505050565b6001600160a01b03811681146105c457600080fd5b6000806040838503121561083257600080fd5b823561083d8161080a565b946020939093013593505050565b6000806000806060858703121561086157600080fd5b84356003811061087057600080fd5b9350602085013567ffffffffffffffff81111561088c57600080fd5b8501601f8101871361089d57600080fd5b803567ffffffffffffffff8111156108b457600080fd5b8760208284010111156108c657600080fd5b949760209190910196509394604001359392505050565b6000602082840312156108ef57600080fd5b81356108038161080a565b60008060006060848603121561090f57600080fd5b833567ffffffffffffffff81111561092657600080fd5b8401610160818703121561093957600080fd5b95602085013595506040909401359392505050565b604081526000835180604084015260005b8181101561097c576020818701810151606086840101520161095f565b506000606082850101526060601f19601f8301168401019150508260208301529392505050565b6000602082840312156109b557600080fd5b5051919050565b6000808335601e198436030181126109d357600080fd5b83018035915067ffffffffffffffff8211156109ee57600080fd5b602001915036819003821315610a0357600080fd5b925092905056fea2646970667358221220d6cfd2daa7a11107524ba8780b67d73066854c8b60f5723df87c620fdf5393d564736f6c634300081a0033"

const PAYMASTER_V07_BYTECODE: Hex =
    "0x60a060405234801561001057600080fd5b50604051610c53380380610c5383398101604081905261002f91610166565b8061003933610054565b610042816100a4565b6001600160a01b0316608052506101b8565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6040516301ffc9a760e01b815263122a0e9b60e31b60048201526001600160a01b038216906301ffc9a790602401602060405180830381865afa1580156100ef573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101139190610196565b6101635760405162461bcd60e51b815260206004820152601e60248201527f49456e747279506f696e7420696e74657266616365206d69736d617463680000604482015260640160405180910390fd5b50565b60006020828403121561017857600080fd5b81516001600160a01b038116811461018f57600080fd5b9392505050565b6000602082840312156101a857600080fd5b8151801515811461018f57600080fd5b608051610a4f6102046000396000818161019101528181610255015281816102ec0152818161038e01528181610428015281816104980152818161052501526106550152610a4f6000f3fe6080604052600436106100a75760003560e01c8063b0d691fe11610064578063b0d691fe1461017f578063bb9fe6bf146101b3578063c23a5cea146101c8578063c399ec88146101e8578063d0e30db01461020b578063f2fde38b1461021357600080fd5b80630396cb60146100ac578063205c2878146100c157806352b7512c146100e1578063715018a6146101185780637c627b211461012d5780638da5cb5b1461014d575b600080fd5b6100bf6100ba3660046107e1565b610233565b005b3480156100cd57600080fd5b506100bf6100dc366004610823565b6102be565b3480156100ed57600080fd5b506101016100fc36600461084f565b610330565b60405161010f9291906108a3565b60405180910390f35b34801561012457600080fd5b506100bf610354565b34801561013957600080fd5b506100bf6101483660046108f8565b610368565b34801561015957600080fd5b506000546001600160a01b03165b6040516001600160a01b03909116815260200161010f565b34801561018b57600080fd5b506101677f000000000000000000000000000000000000000000000000000000000000000081565b3480156101bf57600080fd5b506100bf610384565b3480156101d457600080fd5b506100bf6101e3366004610995565b610401565b3480156101f457600080fd5b506101fd610480565b60405190815260200161010f565b6100bf610510565b34801561021f57600080fd5b506100bf61022e366004610995565b610572565b61023b6105f0565b604051621cb65b60e51b815263ffffffff821660048201527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031690630396cb609034906024016000604051808303818588803b1580156102a257600080fd5b505af11580156102b6573d6000803e3d6000fd5b505050505050565b6102c66105f0565b60405163040b850f60e31b81526001600160a01b038381166004830152602482018390527f0000000000000000000000000000000000000000000000000000000000000000169063205c287890604401600060405180830381600087803b1580156102a257600080fd5b6060600061033c61064a565b6103478585856106ba565b915091505b935093915050565b61035c6105f0565b6103666000610721565b565b61037061064a565b61037d8585858585610771565b5050505050565b61038c6105f0565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031663bb9fe6bf6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156103e757600080fd5b505af11580156103fb573d6000803e3d6000fd5b50505050565b6104096105f0565b60405163611d2e7560e11b81526001600160a01b0382811660048301527f0000000000000000000000000000000000000000000000000000000000000000169063c23a5cea90602401600060405180830381600087803b15801561046c57600080fd5b505af115801561037d573d6000803e3d6000fd5b6040516370a0823160e01b81523060048201526000907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316906370a0823190602401602060405180830381865afa1580156104e7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061050b91906109b2565b905090565b60405163b760faf960e01b81523060048201527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169063b760faf99034906024016000604051808303818588803b15801561046c57600080fd5b61057a6105f0565b6001600160a01b0381166105e45760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084015b60405180910390fd5b6105ed81610721565b50565b6000546001600160a01b031633146103665760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016105db565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146103665760405162461bcd60e51b815260206004820152601560248201527414d95b99195c881b9bdd08115b9d1c9e541bda5b9d605a1b60448201526064016105db565b6060600060146106cd60e08701876109cb565b905011156106fa576106e260016000806107a9565b6040805160208101909152600081529250905061034c565b61070760008060006107a9565b604080516020810190915260008152969095509350505050565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b60405162461bcd60e51b815260206004820152600d60248201526c6d757374206f7665727269646560981b60448201526064016105db565b600060d08265ffffffffffff16901b60a08465ffffffffffff16901b856107d15760006107d4565b60015b60ff161717949350505050565b6000602082840312156107f357600080fd5b813563ffffffff8116811461080757600080fd5b9392505050565b6001600160a01b03811681146105ed57600080fd5b6000806040838503121561083657600080fd5b82356108418161080e565b946020939093013593505050565b60008060006060848603121561086457600080fd5b833567ffffffffffffffff81111561087b57600080fd5b8401610120818703121561088e57600080fd5b95602085013595506040909401359392505050565b604081526000835180604084015260005b818110156108d157602081870181015160608684010152016108b4565b506000606082850101526060601f19601f8301168401019150508260208301529392505050565b60008060008060006080868803121561091057600080fd5b85356003811061091f57600080fd5b9450602086013567ffffffffffffffff81111561093b57600080fd5b8601601f8101881361094c57600080fd5b803567ffffffffffffffff81111561096357600080fd5b88602082840101111561097557600080fd5b959860209190910197509495604081013595606090910135945092505050565b6000602082840312156109a757600080fd5b81356108078161080e565b6000602082840312156109c457600080fd5b5051919050565b6000808335601e198436030181126109e257600080fd5b83018035915067ffffffffffffffff8211156109fd57600080fd5b602001915036819003821315610a1257600080fd5b925092905056fea2646970667358221220ca8478653462c25ef42b4fdd156eea1b64dc91b9ed2107a14d055a33eab779a264736f6c634300081a0033"

const publicClient = createPublicClient({
    transport: http(ANVIL_RPC),
    chain: foundry
})

export const deployPaymaster = async (
    entryPoint: Address
): Promise<Address> => {
    let createBytecode = PAYMASTER_V07_BYTECODE

    if (entryPoint === entryPoint06Address) {
        createBytecode = PAYMASTER_V06_BYTECODE
    }

    const counterFactual = getCreate2Address({
        from: "0x4e59b44847b379578588920ca78fbf26c0b4956c",
        salt: "0x0000000000000000000000000000000000000000000000000000000000000000",
        bytecode: concat([createBytecode, pad(entryPoint)])
    })

    const bytecode = await publicClient.getCode({
        address: counterFactual
    })

    if (!bytecode) {
        // if it doesn't exist, deploy it
        const walletClient = getAnvilWalletClient(0)

        await walletClient.sendTransaction({
            data: concat([
                "0x0000000000000000000000000000000000000000000000000000000000000000",
                createBytecode,
                pad(entryPoint)
            ]),
            to: "0x4e59b44847b379578588920ca78fbf26c0b4956c"
        })

        // deposit 100ETH to the deployed paymaster
        await walletClient.sendTransaction({
            to: counterFactual,
            value: parseEther("100"),
            data: "0xd0e30db0" /* sig for deposit() */
        })
    }

    return counterFactual
}
